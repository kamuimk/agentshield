# AgentShield v0.4 PRD

## 프로젝트 개요

AgentShield는 AI 에이전트(OpenClaw, Claude Code 등)의 아웃바운드 네트워크 트래픽을 제어하는
투명 이그레스 방화벽(Transparent Egress Firewall)이다.

- GitHub: https://github.com/kamuimk/agentshield
- Language: Rust (edition 2024, MSRV 1.85)
- License: Apache-2.0

## v0.3 현황

프록시 → 정책 → DLP → 로깅(connection pool) → 알림 → system allowlist까지 전체 파이프라인이
end-to-end로 동작하는 상태. CI 4회 연속 Green.

- 117개 테스트 (unit + integration)
- 15개 DLP 패턴 (10개 AI 프로바이더 + 5개 인프라/범용)
- r2d2 SQLite connection pool (max_size=4)
- Telegram 알림 (fire-and-forget, Notifier trait)
- System allowlist (정책 bypass)
- tracing 전면 적용 (println! 제거)
- OpenClaw integrate 커맨드
- 3개 정책 템플릿 (openclaw-default, claude-code-default, strict)

### v0.3 미해결 이슈 (본 PRD의 근거)

| # | 이슈 | 우선순위 | 근거 |
|---|------|---------|------|
| 1 | System allowlist가 DLP를 스킵하지 않음 | P1 | 알림 본문에 API key가 포함되면 Telegram 전송이 차단됨 |
| 2 | Notification events 필터 미구현 | P1 | `events = ["deny"]` 설정해도 DLP 알림도 전송 |
| 3 | Telegram bot_token TOML 평문 노출 | P2 | git 커밋 시 토큰 유출 위험 |
| 4 | `handle_http_request` 인자 8개 | P2 | clippy suppress로 넘김, 확장성 한계 |
| 5 | OpenAI `sk-None-`, `sk-admin-` 패턴 누락 | P2 | 최신 OpenAI 키 변형 미탐지 |
| 6 | Fireworks AI `fw_` prefix 근거 없음 | P3 | 오탐 위험 |
| 7 | `cmd_status()` 전체 테이블 로드 | P3 | 로그 증가 시 메모리 이슈 |

## v0.4 목표

v0.3 코드 리뷰에서 발견된 P1/P2 이슈를 해결하고, HN 공개 전 마지막 품질 개선을 완료한다.
코드 구조를 리팩토링하여 v0.5(rate limiting, wildcard 매칭 등) 확장에 대비한다.

## 요구사항

### R1: System Allowlist DLP Bypass 정책 [P1]

**배경**: `system_allowlist`에 등록된 도메인(예: `api.telegram.org`)은 정책 평가를 bypass하지만,
DLP 스캔은 여전히 실행된다. 알림 메시지 본문에 API key가 포함될 수 있는 edge case에서
Telegram 전송 자체가 DLP에 의해 차단될 수 있다.

**기능 요구사항**:
1. `system_allowlist` 도메인으로의 요청은 DLP 스캔도 bypass
2. `system-allow` action으로 로깅 시 "policy+dlp bypass" reason 명시
3. 보안 주석 추가: system allowlist는 내부 서비스 전용이며, 외부 도메인 등록 시 DLP 보호가 해제됨을 경고

**기술 설계**:
- `connect.rs`의 `handle_http_request`에서 `system_allowed == true`일 때 DLP 블록(line 396-437) 건너뛰기
- `handle_connect`는 이미 DLP를 스킵하므로 변경 불필요

**테스트**:
- system allowlist 도메인으로의 HTTP POST에 API key 포함 → 403이 아닌 통과 확인
- system allowlist에 없는 도메인 → 기존 DLP 동작 유지 확인

**예상 소요**: 30분

---

### R2: Notification Events 필터 구현 [P1]

**배경**: `TelegramConfig.events: Vec<String>`이 config에 정의되어 있지만, `connect.rs`에서
이벤트 타입별 필터링을 하지 않는다. 모든 deny와 DLP critical이 무조건 알림으로 전송된다.

**기능 요구사항**:
1. `events` 필드로 알림 이벤트 타입 필터링:
   - `"deny"`: 정책에 의한 차단 (RequestDenied)
   - `"dlp"`: DLP critical 탐지 (DlpFinding)
   - `"start"`: 프록시 시작 (ProxyStarted)
   - `"shutdown"`: 프록시 종료 (ProxyShutdown)
   - 빈 배열 또는 미지정: 전체 이벤트 전송 (하위 호환)
2. `NotificationEvent`에 이벤트 타입 문자열을 반환하는 `event_type()` 메서드 추가
3. `Notifier` trait 래퍼 또는 `FilteredNotifier`에서 events 체크 후 전달

**기술 설계**:
```rust
impl NotificationEvent {
    pub fn event_type(&self) -> &str {
        match self {
            Self::RequestDenied { .. } => "deny",
            Self::DlpFinding { .. } => "dlp",
            Self::ProxyStarted { .. } => "start",
            Self::ProxyShutdown => "shutdown",
        }
    }
}

pub struct FilteredNotifier {
    inner: Arc<dyn Notifier>,
    allowed_events: Vec<String>,
}
```

**TOML 예시**:
```toml
[notification]
enabled = true

[notification.telegram]
bot_token = "123456:ABC"
chat_id = "-100123"
events = ["deny", "dlp"]    # start/shutdown 알림 제외
```

**테스트**:
- `events = ["deny"]` → DLP finding 알림 미전송 확인
- `events = ["dlp"]` → RequestDenied 알림 미전송 확인
- `events = []` 또는 미지정 → 전체 이벤트 전송 확인 (하위 호환)
- MockNotifier로 수신 이벤트 수 검증

**예상 소요**: 1시간

---

### R3: Config 환경변수 참조 지원 [P2]

**배경**: `agentshield.toml`에 Telegram bot_token이 평문으로 들어가며,
git 커밋 시 토큰이 유출될 위험이 있다.

**기능 요구사항**:
1. TOML 값에서 `${ENV_VAR}` 또는 `$ENV_VAR` 패턴을 환경변수 값으로 치환
2. 환경변수 미설정 시 startup에서 명확한 에러 메시지 출력 후 종료
3. bot_token, chat_id 등 시크릿성 필드에 우선 적용
4. 일반 필드(listen, default 등)에도 동일하게 동작

**기술 설계**:
- `AppConfig::load_from_path`에서 TOML 파싱 전에 환경변수 치환 수행
- regex: `\$\{([A-Za-z_][A-Za-z0-9_]*)\}` 또는 단순 `\$([A-Z_][A-Z0-9_]*)`
- 치환 실패 시 `AgentShieldError::ConfigParse`로 에러

**TOML 예시**:
```toml
[notification.telegram]
bot_token = "${AGENTSHIELD_TELEGRAM_TOKEN}"
chat_id = "${AGENTSHIELD_TELEGRAM_CHAT_ID}"
```

**테스트**:
- 환경변수 설정 → 정상 파싱 확인
- 환경변수 미설정 → 에러 메시지에 변수명 포함 확인
- `${}` 없는 일반 값 → 그대로 통과 확인

**예상 소요**: 1시간

---

### R4: ConnectionContext 리팩토링 [P2]

**배경**: `handle_http_request`의 인자가 8개로, `#[allow(clippy::too_many_arguments)]`로
suppress 중. v0.4에서 events 필터, v0.5에서 rate limiting 추가 시 더 늘어날 예정.

**기능 요구사항**:
1. 프록시 핸들러에 전달되는 공유 상태를 `ConnectionContext` struct로 통합
2. `accept_loop`, `handle_connection`, `handle_connect`, `handle_http_request` 시그니처 정리
3. `#[allow(clippy::too_many_arguments)]` 제거

**기술 설계**:
```rust
pub struct ConnectionContext {
    pub policy: Option<Arc<PolicyConfig>>,
    pub db: Option<DbPool>,
    pub ask_tx: Option<mpsc::Sender<AskRequest>>,
    pub dlp_scanner: Option<Arc<dyn DlpScanner>>,
    pub system_allowlist: Option<Arc<Vec<String>>>,
    pub notifier: Option<Arc<dyn Notifier>>,
}
```
- `Arc<ConnectionContext>`로 clone하여 각 connection task에 전달
- `ProxyServer::start()`에서 `ConnectionContext` 생성

**테스트**:
- 기존 프록시 테스트 전부 통과 확인 (API 변경 없음, 내부 리팩토링)

**예상 소요**: 1시간

---

### R5: DLP 패턴 최신화 [P2]

**배경**: 2026년 2월 기준 API key 포맷 조사 결과, 현재 패턴에 누락/오류가 발견됨.

**변경 사항**:

#### 5-1. OpenAI 패턴 업데이트
현재: `sk-(?:proj-|svcacct-)?[A-Za-z0-9_-]{20,}`

OpenAI는 현재 4가지 키 변형을 사용:
- `sk-proj-` (프로젝트 키)
- `sk-svcacct-` (서비스 계정 키)
- `sk-None-` (사용자 키, 프로젝트 미지정)
- `sk-admin-` (Admin API 키)

변경: `sk-(?:proj-|svcacct-|None-|admin-)?[A-Za-z0-9_-]{20,}`

> 주의: `sk-admin-`은 Anthropic `sk-ant-`와 겹치지 않음 (Anthropic은 `sk-ant-api03-` 또는 `sk-ant-admin-`)

#### 5-2. Fireworks AI 패턴 재검토
현재: `fw_[A-Za-z0-9]{20,}` (prefix 기반)

Fireworks AI 공식 문서, GitGuardian, liteLLM 어디에서도 `fw_` prefix를 확인할 수 없다.
Fireworks는 API 응답의 `prefix` 필드로 사용자별 다른 prefix를 사용하는 구조.

변경 옵션:
- A) 컨텍스트 기반으로 변경: `(?i)(?:fireworks[_-]?(?:api[_-]?)?key)\s*[:=]\s*["']?([A-Za-z0-9_-]{32,})["']?`
- B) 확인될 때까지 제거하고 `generic-api-key` 패턴에 의존
- **권장: 옵션 A** (false positive 줄이면서 커버리지 유지)

#### 5-3. Together AI 패턴 완화
현재: `[A-Fa-f0-9]{64}` (hex 64자 고정)

Together AI 키가 반드시 hex 64자인지 공식 문서에서 확인 불가.
변경: `[A-Za-z0-9]{32,}` (alphanumeric 32자 이상)

**테스트**:
- `sk-None-xxx...` 키 탐지 확인
- `sk-admin-xxx...` 키 탐지 확인 (OpenAI)
- `sk-ant-admin...` 키 → anthropic-api-key로 탐지 확인 (OpenAI 아님)
- Fireworks 컨텍스트 기반 탐지 확인
- Together AI alphanumeric 키 탐지 확인

**예상 소요**: 30분

---

### R6: `cmd_status()` SQL 집계 최적화 [P3]

**배경**: 현재 `query_recent(conn, usize::MAX)`로 전체 테이블을 메모리에 로드한 뒤
Rust에서 filter/count. 로그가 수만 건 이상이면 메모리 낭비.

**기능 요구사항**:
1. SQL `COUNT(*) ... GROUP BY action`으로 DB 레벨 집계
2. 총 요청 수, action별 카운트를 단일 쿼리로 반환

**기술 설계**:
```rust
pub struct RequestStats {
    pub total: usize,
    pub allowed: usize,
    pub denied: usize,
    pub asked: usize,
    pub system_allowed: usize,
}

pub fn query_stats(conn: &Connection) -> Result<RequestStats> {
    // SELECT action, COUNT(*) as cnt FROM requests GROUP BY action
}
```

**테스트**:
- 10개 혼합 로그 insert 후 stats 정확성 확인
- 빈 DB에서 all-zero 반환 확인

**예상 소요**: 30분

---

## 우선순위 요약 및 일정

| 요구사항 | 우선순위 | 예상 소요 | 의존성 |
|---------|---------|----------|--------|
| R1: System Allowlist DLP Bypass | P1 | 30분 | 없음 |
| R2: Notification Events 필터 | P1 | 1시간 | 없음 |
| R3: Config 환경변수 참조 | P2 | 1시간 | 없음 |
| R4: ConnectionContext 리팩토링 | P2 | 1시간 | R1 이후 |
| R5: DLP 패턴 최신화 | P2 | 30분 | 없음 |
| R6: cmd_status SQL 집계 | P3 | 30분 | 없음 |
| **합계** | | **~4.5시간** | |

**구현 순서 권장**: R1 → R5 → R2 → R3 → R4 → R6

- R1을 먼저 해야 R4 리팩토링 시 system_allowed 분기가 깔끔해짐
- R5는 독립적이라 아무 때나 가능하지만 빨리 하는 게 좋음 (DLP 정확도)
- R4는 R1, R2 완료 후에 해야 최종 인자 목록이 확정됨

## 비기능 요구사항

- CI Green 유지 (cargo fmt + clippy + test)
- 기존 117개 테스트 + R1~R6 신규 테스트 ≥ 130개
- README.md 업데이트: 환경변수 참조 문법, events 필터 설명 추가
- `version = "0.4.0"` Cargo.toml 업데이트

## 향후 v0.5 고려사항 (본 PRD 범위 밖)

- Rate limiting (도메인/메서드별 요청 속도 제한)
- Wildcard 도메인 매칭 (`*.github.com`)
- 정책 hot-reload (SIGHUP 또는 파일 감시)
- Claude Code 연동 (`agentshield integrate claude-code`)
- MITM HTTPS inspection (v0.3에서 "CONNECT tunnel은 DLP 불가" → 해결)
- 웹 대시보드 (로그 조회, 정책 편집)
