# AgentShield v0.2 PRD - Code Review V2 이슈 해결

## 프로젝트 개요

AgentShield는 AI 에이전트(OpenClaw, Claude Code 등)의 아웃바운드 네트워크 트래픽을 제어하는
투명 이그레스 방화벽(Transparent Egress Firewall)이다.

- GitHub: https://github.com/kamuimk/agentshield
- Language: Rust (edition 2024, MSRV 1.85)
- License: Apache-2.0

## v0.1 현황

프록시 → 정책 → 로깅 파이프라인이 완성되어 실제로 동작하는 egress firewall 상태.
- 81개 테스트 (unit + integration)
- OpenClaw Telegram 채널 프록시 연동 (`agentshield integrate openclaw`)
- TOML 기반 정책 엔진 (도메인/메서드별 allow/deny/ask)
- SQLite 요청 로깅 + JSON/CSV 내보내기
- DLP RegexScanner 구현 (7개 패턴) - **프록시에 미연결**

## v0.2 목표

Code Review V2에서 발견된 P1/P2 이슈 해결.
DLP 스캐너를 프록시에 연결하여 민감 데이터 유출 방지 기능을 완성한다.

## 요구사항

### R1: DLP 스캐너 프록시 연결 [P1]

**배경**: RegexScanner가 구현되어 있지만 connect.rs에서 호출하지 않아 단위 테스트에서만 동작.

**기능 요구사항**:
1. ProxyServer에 `with_dlp(scanner: Arc<dyn DlpScanner>)` 빌더 메서드 추가
2. HTTP 평문 요청의 body를 `\r\n\r\n` 이후로 추출하여 DLP 스캔 실행
3. Critical severity (openai-api-key, aws-access-key, private-key, github-token) → 403 차단 + DB 로깅 + tracing::warn
4. Non-critical severity (email, generic-api-key) → tracing::warn 로깅만, 요청은 통과
5. CONNECT 터널(HTTPS)은 암호화되어 스캔 불가 → DLP 스킵
6. TOML `[dlp]` 섹션으로 활성화/패턴 선택 제어:
   ```toml
   [dlp]
   enabled = true
   # patterns = ["openai-api-key", "aws-access-key"]  # 선택적, 미지정 시 전체 패턴
   ```

**기술 설계**:
- DLP 스캔 위치: 정책 평가 후 (allow/ask 승인 후), 원격 서버 전송 전
- `extract_body()` 헬퍼 함수로 raw_request에서 body 분리
- 기존 Builder 패턴 (`with_policy`, `with_db`, `with_ask_channel`) 동일하게 확장
- `accept_loop` → `handle_connection` → `handle_http_request`로 `Option<Arc<dyn DlpScanner>>` 전파

**수정 파일**:
- `src/proxy/mod.rs` - ProxyServer 구조체 + 빌더
- `src/proxy/connect.rs` - 함수 시그니처 + DLP 스캔 로직
- `src/main.rs` - DlpConfig → RegexScanner 초기화

**재사용 코드**:
- `DlpScanner` trait: `src/dlp/mod.rs`
- `RegexScanner`: `src/dlp/patterns.rs`
- `DlpConfig`: `src/policy/config.rs` (이미 AppConfig에 포함)

### R2: ASK 채널 보안 강화 [P1]

**배경**: `ask_and_wait()` 함수에서 ASK 채널이 없을 때 `ask_tx.is_none()` = `true` (allow)를 반환하여
정책이 ASK인 요청이 무조건 허용되는 보안 취약점이 있음. 또한 `cmd_start()`에서 ASK 채널을
생성하지 않아 실제 운영 시 이 취약 경로를 항상 타게 됨.

**기능 요구사항**:
1. `ask_and_wait()`: 채널 미존재 또는 에러 시 `false` (deny) 반환 (fail-closed)
2. `cmd_start()`: ASK 채널(mpsc) 항상 생성 + stdin/stdout 기반 interactive prompt 스폰
3. `prompt_decision()` (기존 구현) 호출하여 사용자 승인/거부 처리

**수정 파일**:
- `src/proxy/connect.rs` - line 113-114: `ask_tx.is_none()` → `false`
- `src/main.rs` - ASK 채널 생성 + tokio::spawn으로 prompt handler

**영향 범위**:
- 기존 `e2e_openclaw_full_flow` 테스트: ASK 채널 없이 ASK 규칙 테스트하므로 수정 필요
  → ASK 채널 + auto-approve로 변경

### R3: README 정비 [P1]

**수정 내용**:
1. Quick Start에 `agentshield integrate openclaw` 사용법 추가 (Node.js 앱용)
2. CLI Commands 섹션에 `integrate openclaw`, `integrate remove` 추가
3. 테스트 수를 최종 값으로 업데이트
4. Docker 섹션에 Node.js 23의 `HTTP_PROXY` 환경변수 미지원 주의사항 추가
5. Development 섹션에 MSRV 1.85 명시

### R4: Cargo.toml MSRV [P2]

- `rust-version = "1.85"` 필드 추가
- Rust 2024 edition은 1.85.0에서 안정화됨

### R5: 코드 품질 확인 [P2]

- Issue 3.3 (let-chain): Rust 2024 edition에서 안정화. CI `cargo test` 통과로 확인.
- Issue 3.4 (Mutex 성능): MVP 적합. 향후 connection pool 고려.

## 테스트 계획

### 새로 추가할 테스트

| 테스트명 | 위치 | 유형 | 설명 |
|----------|------|------|------|
| `ask_policy_without_channel_defaults_to_deny` | integration_test.rs | 통합 | ASK 채널 없을 때 403 반환 |
| `dlp_blocks_http_request_with_critical_finding` | proxy_test.rs | 통합 | API 키 포함 HTTP → 403 |
| `dlp_allows_clean_http_request` | proxy_test.rs | 통합 | 깨끗한 HTTP → 통과 |
| `dlp_does_not_scan_connect_tunnels` | proxy_test.rs | 통합 | CONNECT → DLP 무시 |
| `extract_body_from_raw_request` | connect.rs | 단위 | body 추출 로직 |
| `no_body_in_get_request` | connect.rs | 단위 | body 없는 GET 요청 |

### 수정할 기존 테스트

| 테스트명 | 변경 내용 |
|----------|-----------|
| `e2e_openclaw_full_flow` | ASK 채널 추가 (auto-approve) |

### 검증 커맨드

```bash
cargo test --all           # 전체 테스트 통과
cargo clippy -- -D warnings  # Clippy 경고 0
cargo fmt --check           # 포맷 일치
```

## 완료 기준

1. 모든 테스트 통과 (기존 81 + 신규 6 = 87+)
2. `cargo clippy -- -D warnings` 경고 0
3. `[dlp] enabled = true` 설정 시 HTTP 요청 body DLP 스캔 동작 확인
4. Critical DLP finding → 403 차단 확인
5. ASK 정책 + 채널 미존재 → deny 확인
6. README가 현재 기능(integrate, MSRV, 테스트 수)과 일치
7. `.taskmaster/docs/prd.txt` PRD 문서 생성 완료

## 향후 과제 (v0.3+)

- `println!` → `tracing` 매크로 통일 (main.rs에 59개 잔존)
- Notification trait + Telegram 알림 (deny/DLP 이벤트 실시간 알림)
- 시스템 allowlist (알림 채널 자기 차단 방지)
- `Mutex<Connection>` → connection pool (r2d2-sqlite)
- Phase 2: macOS pf 방화벽 기반 투명 프록시 (모든 프로세스 트래픽 강제 리다이렉트)
- MITM TLS (v0.3): CONNECT 터널 내부 DLP 스캔 가능
- Node.js 24+ `NODE_USE_ENV_PROXY=1` 환경변수 프록시 지원 활용
