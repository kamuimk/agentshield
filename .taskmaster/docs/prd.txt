
OPEN SOURCE PROJECT PRD
AgentShield
AI Agent Egress Firewall
────────────────────────────────────────
Personal Open Source Project
First Target: OpenClaw
Version 0.1 (Dev Spec) | February 2026
Author: Kay

"Default-deny egress control for AI agents."
Stop data exfiltration before it happens.

1. Project Overview
AgentShield는 AI 에이전트(OpenClaw, Claude Code 등)의 아웃바운드 트래픽을 제어하고 감사하는 오픈소스 투명 프록시이다. 개인 프로젝트로 시작하여, OpenClaw을 첫 번째 타겟으로 한다.
1.1 핵심 철학
Default-Deny: 모든 아웃바운드 트래픽은 기본적으로 차단. 명시적으로 허용한 것만 통과.
Gradual Allow: 승인 이력이 축적되어 점진적으로 정책이 자동 생성됨.
Transparent: 에이전트 코드 수정 없이 투명 프록시로 동작.
1.2 왔 OpenClaw 부터?
	•	OpenClaw은 완전한 오픈소스라 소스 분석과 통합 포인트 파악이 용이
	•	Gateway 아키텍쳐가 이미 프록시 패턴과 유사하여 통합이 자연스러움
	•	42,900개 인스턴스가 노출된 실제 보안 문제가 있어 수요가 명확
	•	180K+ GitHub 스타의 거대한 사용자층이 존재
	•	멀티 채널 (WhatsApp, Telegram, Slack 등) 통합으로 공격 표면이 넓어 보안 니즈가 가장 급함
1.3 오픈소스 전략
	•	License: Apache 2.0 (상업적 사용 허용, 기업 도입 장벽 낮춤)
	•	보안 도구는 소스 공개가 신뢰의 전제조건
	•	커뮤니티 기여 정책 템플릿이 핵심 자산이 됨
	•	추후 상업화 시 managed SaaS로 수익화 가능 (OSS core + commercial cloud)
2. Tech Stack
컴포넌트
기술 선택
선택 이유
Language
Rust
고성능 프록시 요구사항. 메모리 안전성. 보안 도구에 적합한 신뢰성.
Proxy Core
hyper + rustls (TLS) + tokio (async)
Rust 네이티브 HTTP 프록시. MITM TLS 지원 필요.
Policy Engine
YAML/TOML config + Rust 내장 평가기
MVP는 외부 의존성 없이 단순하게. 추후 OPA/Cedar 통합.
Storage
SQLite (embedded)
로컬 우선. 설치 의존성 제로. 로그 + 정책 + 승인 이력 저장.
CLI
clap (Rust CLI framework)
모든 설정/모니터링을 CLI로 제공. TUI 대시보드는 추후.
Config Format
TOML (주) + YAML (템플릿)
Rust 생태계 표준. 사람이 읽기 쉽고 Git 친화적.

Alternative 고려: Go도 유력한 후보 (envoyproxy, mitmproxy 생태계). 프로토타입 속도를 우선한다면 Go, 성능/신뢰성을 우선한다면 Rust. 초기에는 프로토타입 속도가 중요하므로 Go로 시작하는 것도 합리적.
3. Architecture
3.1 전체 흐름
아래는 OpenClaw Gateway가 외부 API를 호출할 때의 흐름이다:

  OpenClaw Gateway
       |
       | HTTP/HTTPS (HTTPS_PROXY 환경변수로 설정)
       v
  +---------------------+
  |   AgentShield       |
  |   Proxy (localhost)  |
  |                     |
  |  1. 요청 가로채기    |
  |  2. 정책 평가        |
  |  3. DLP 스캔         |
  |  4. 로깅            |
  |  5. 허용/차단 결정  |
  +---------------------+
       |
       | 허용된 요청만 통과
       v
  External API (api.anthropic.com, github.com, ...)

3.2 프록시 동작 모드
CONNECT 터널링 (HTTPS): OpenClaw Gateway가 HTTPS 요청 시 CONNECT 메서드로 터널을 열고, AgentShield는 도메인 레벨에서 정책을 평가한다. 페이로드 검사가 필요한 경우 MITM TLS를 수행하고, 로컬 CA 인증서를 설치한다.

HTTP 요청: 일반 HTTP 요청은 투명하게 가로채여 전체 페이로드를 검사할 수 있다.
3.3 정책 평가 흐름
각 요청에 대해 아래 순서로 평가한다:

  Request → Domain Check → Endpoint Check → Payload DLP → Decision
                |              |               |            |
             denylist?      allowlist?     PII/cred?    ALLOW/DENY/ASK

	•	ALLOW: 정책에 명시적으로 허용된 요청. 통과 + 로깅.
	•	DENY: 정책에 의해 차단된 요청. 차단 + 로깅 + 선택적 알림.
	•	ASK: 정책에 정의되지 않은 요청. 사용자에게 승인 프롬프트를 표시하고, 승인/거부 결과를 향후 정책 추천에 활용.
4. MVP Feature Spec (v0.1)
MVP는 최소한의 기능으로 OpenClaw과 함께 쓸 수 있는 수준을 목표로 한다.
4.1 투명 프록시
	•	localhost에서 동작하는 HTTP/HTTPS 프록시
	•	OpenClaw Gateway의 아웃바운드 트래픽을 AgentShield 프록시로 라우팅
	•	CONNECT 터널링 지원 (도메인 레벨 필터링)
	•	선택적 MITM TLS (페이로드 검사 필요 시)
4.2 정책 엔진
	•	TOML 기반 정책 파일
	•	도메인 allowlist / denylist
	•	엔드포인트 패턴 매칭 (e.g., GET /repos/* 허용, DELETE /repos/* 차단)
	•	기본값: deny-all

예시 정책 파일 (agentshield.toml):

[proxy]
listen = "127.0.0.1:18080"
mode = "transparent"    # transparent | mitm

[policy]
default = "deny"        # deny | ask | allow

[[policy.rules]]
name = "anthropic-api"
domains = ["api.anthropic.com"]
action = "allow"

[[policy.rules]]
name = "github-readonly"
domains = ["api.github.com"]
methods = ["GET"]
action = "allow"

[[policy.rules]]
name = "github-write"
domains = ["api.github.com"]
methods = ["POST", "PUT", "DELETE"]
action = "ask"

[[policy.rules]]
name = "npm-registry"
domains = ["registry.npmjs.org"]
action = "allow"

[dlp]
enabled = false         # MVP에서는 선택적
patterns = ["AWS_KEY", "GITHUB_TOKEN", "PII_EMAIL"]
4.3 로깅
	•	SQLite에 모든 요청 로깅 (timestamp, method, domain, path, action, reason)
	•	CLI로 로그 조회: agentshield logs --tail 50
	•	JSON export 지원: agentshield logs --export --format json
4.4 승인 프롬프트
default=deny 또는 action=ask인 요청이 발생하면, 터미널에 승인 프롬프트를 표시한다:

  ┌────────────────────────────────────────────────┐
  │  AgentShield: New outbound request          │
  ├────────────────────────────────────────────────┤
  │  POST api.github.com/repos/user/repo/pulls  │
  │                                              │
  │  [a] Allow once                              │
  │  [r] Add rule (always allow this pattern)    │
  │  [d] Deny                                    │
  │  [i] Inspect payload                         │
  └────────────────────────────────────────────────┘

	•	[r] 선택 시 자동으로 agentshield.toml에 룰 추가 (점진적 허용)
	•	[i] 선택 시 요청 body를 표시하여 민감 데이터 확인 가능
4.5 CLI 커맨드
커맨드
설명
agentshield start
프록시 시작 (foreground / --daemon)
agentshield stop
프록시 정지
agentshield status
현재 상태 표시 (활성 연결, 차단/허용 통계)
agentshield logs [--tail N]
최근 로그 조회
agentshield logs --export
JSON/CSV로 로그 내보내기
agentshield policy show
현재 정책 표시
agentshield policy add <rule>
정책 룰 추가 (interactive)
agentshield policy template <name>
템플릿 적용 (e.g., openclaw-default)
agentshield init
초기 설정 위저드 (정책 파일 생성 + CA 인증서 설치)
5. Usage Flow
5.1 최초 설치 및 실행

# 설치
cargo install agentshield
# 또는
brew install agentshield

# 초기 설정 (정책 파일 생성 + CA 인증서)
agentshield init

# 기본 템플릿 적용
agentshield policy template openclaw-default

# 프록시 시작
agentshield start --daemon

# OpenClaw Gateway에서 사용 (gateway config에 proxy 설정)
# ~/.openclaw/config.yaml 에 추가:
#   gateway:
#     proxy: http://127.0.0.1:18080

# 또는 환경변수로 설정 (범용)
HTTPS_PROXY=http://127.0.0.1:18080 openclaw gateway
5.2 일상 사용 흐름
	•	1. agentshield start --daemon 으로 백그라운드 실행
	•	2. OpenClaw으로 작업 수행 (WhatsApp, Telegram, Slack 등에서 에이전트와 대화)
	•	3. 새로운 도메인/엔드포인트 요청 시 승인 프롬프트 표시
	•	4. 승인하면 통과 + 선택적으로 정책에 추가
	•	5. 시간이 지날수록 승인 프롬프트가 줄어들고 자동화됨
6. Project Structure

agentshield/
├── Cargo.toml
├── README.md
├── LICENSE                    # Apache 2.0
├── CONTRIBUTING.md
├── src/
│   ├── main.rs                # CLI entrypoint
│   ├── proxy/
│   │   ├── mod.rs             # Proxy server core
│   │   ├── tls.rs             # MITM TLS handling
│   │   └── connect.rs         # CONNECT tunneling
│   ├── policy/
│   │   ├── mod.rs             # Policy engine
│   │   ├── config.rs          # TOML config parser
│   │   └── evaluator.rs       # Rule evaluator
│   ├── dlp/
│   │   ├── mod.rs             # DLP scanner
│   │   └── patterns.rs        # Built-in patterns
│   ├── log/
│   │   ├── mod.rs             # SQLite logger
│   │   └── export.rs          # JSON/CSV export
│   └── cli/
│       ├── mod.rs             # CLI commands
│       └── prompt.rs          # Interactive approval
├── templates/
│   ├── openclaw-default.toml
│   ├── claude-code-default.toml
│   └── strict.toml
└── tests/
    ├── proxy_test.rs
    ├── policy_test.rs
    └── integration_test.rs
7. OpenClaw Default Template
openclaw-default.toml 템플릿은 OpenClaw Gateway의 일반적인 사용 패턴에 맞춰 사전 정의된 정책이다:

# OpenClaw Default Policy Template
# OpenClaw Gateway의 일반적인 사용에 필요한 최소한의 허용 룰

[policy]
default = "deny"

# LLM Provider APIs (필수)
[[policy.rules]]
name = "anthropic-api"
domains = ["api.anthropic.com"]
action = "allow"

[[policy.rules]]
name = "openai-api"
domains = ["api.openai.com"]
action = "allow"

# Messaging channels (읽기/쓰기 허용)
[[policy.rules]]
name = "telegram"
domains = ["api.telegram.org"]
action = "allow"

[[policy.rules]]
name = "discord"
domains = ["discord.com", "gateway.discord.gg"]
action = "allow"

[[policy.rules]]
name = "slack"
domains = ["slack.com", "api.slack.com"]
action = "allow"

# Package registries (읽기 전용)
[[policy.rules]]
name = "npm-registry"
domains = ["registry.npmjs.org"]
methods = ["GET"]
action = "allow"

# GitHub (읽기는 허용, 쓰기는 승인 필요)
[[policy.rules]]
name = "github-read"
domains = ["api.github.com", "github.com"]
methods = ["GET"]
action = "allow"

[[policy.rules]]
name = "github-write"
domains = ["api.github.com"]
methods = ["POST", "PUT", "PATCH", "DELETE"]
action = "ask"

# Browser/Web access (에이전트 브라우징 - 승인 필요)
[[policy.rules]]
name = "web-browsing"
domains = ["*"]
action = "ask"
note = "Catch-all for agent web browsing. Review per domain."

# 그 외 모든 요청은 default=deny에 의해 차단
8. Development Roadmap
Phase
목표
구현 항목
기간
v0.1
Working Proxy
투명 프록시 (CONNECT)
TOML 정책 파싱
도메인 allowlist/denylist
SQLite 로깅
CLI (start/stop/logs)
2주
v0.2
Interactive Mode
승인 프롬프트 (ASK 모드)
승인 → 자동 룰 추가
엔드포인트 패턴 매칭
HTTP method 필터링
2주
v0.3
DLP + MITM
MITM TLS (선택적)
페이로드 DLP 스캔
Built-in 패턴 (AWS key, GitHub token 등)
CA 인증서 자동 설치
3주
v0.4
Templates + Community
템플릿 시스템 (openclaw, claude-code 등)
커뮤니티 템플릿 저장소
agentshield init 위저드
README + 문서 정비
2주
v0.5
Polish + Launch
brew/cargo 배포
GitHub Actions CI/CD
통합 테스트
GitHub 공개 + README
1주

총 예상 기간: 약 10주 (주말/저녁 시간 활용 기준)
9. Post-MVP Roadmap
오픈소스 공개 후 커뮤니티 반응에 따라 우선순위를 조정한다.
	•	Learning Mode: 트래픽을 모니터링하여 베이스라인 자동 생성 → 정책 초안 추천
	•	Intent-based Policy: LLM으로 자연어 정책 → TOML 룰 컴파일
	•	Web Dashboard: TUI 대시보드 → 웹 대시보드 (Tauri?)
	•	Multi-agent 지원: 여러 에이전트별 별도 정책/로깅 (agent-id 기반)
	•	Claude Code 통합: HTTPS_PROXY 환경변수 기반 연동
	•	OpenClaw 심층 통합: OpenClaw skill로 패키징하여 ClawHub에 배포
	•	Network Effect: 익명화된 정책 통계 수집 → 커뮤니티 인텔리전스
	•	컴플라이언스 리포트: SOC2/ISO27001용 감사 리포트 자동 생성
	•	상업화 (Managed SaaS): OSS core + cloud 관리형 서비스
10. Success Metrics
10.1 오픈소스 성공 지표
	•	GitHub Stars: 공개 1개월 내 1,000+
	•	Contributors: 3개월 내 외부 기여자 10명+
	•	Community Templates: 3개월 내 20개+ 템플릿
	•	Weekly Active Users: 500+ (telemetry opt-in 기준)
10.2 제품 품질 지표
	•	프록시 레이턴시: 도메인 체크 < 1ms, DLP 스캔 < 10ms
	•	False Positive 차단률: < 1% (정책 템플릿 사용 시)
	•	설치 → 첫 사용: 5분 이내 (agentshield init + template)
11. Getting Started (for Claude Code)
Claude Code에서 이 프로젝트의 개발을 시작할 때 참고할 초기 태스크 목록. 첫 타겟은 OpenClaw Gateway이다:

Task 1: 프로젝트 스캐폴딩
	•	Rust 프로젝트 초기화 (cargo init agentshield)
	•	위 프로젝트 구조에 맞춰 디렉토리 생성
	•	Cargo.toml에 의존성 추가: hyper, rustls, tokio, clap, rusqlite, toml, serde

Task 2: 기본 프록시
	•	HTTP CONNECT 터널링 구현
	•	localhost:18080에서 리스닝
	•	HTTPS_PROXY=http://127.0.0.1:18080 curl https://api.anthropic.com 으로 테스트
	•	OpenClaw Gateway에 proxy 설정 후 실제 에이전트 트래픽으로 통합 테스트

Task 3: 정책 엔진
	•	TOML 파서 구현 (agentshield.toml)
	•	도메인 기반 allow/deny 로직
	•	차단 시 403 응답 + x-agentshield-reason 헤더

Task 4: 로깅
	•	SQLite 스키마 정의 (requests 테이블)
	•	모든 요청 로깅 (허용/차단 모두)
	•	CLI logs 커맨드 구현

Task 5: 승인 프롬프트
	•	차단된 요청에 대한 터미널 프롬프트
	•	Allow once / Add rule / Deny 선택지
	•	Add rule 시 agentshield.toml 자동 수정
